<html>
  <head>
    <title>Evolution Simulator</title>
    <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1','packages':['corechart']}]}"></script>
    <script type="text/javascript" src="evolution.js"></script>
    <style type="text/css">
#universe, #controls, #chart {
  display: table;
  margin: 1em auto;
}
#universe {
  border: 2px solid red;
}
#controls a {
  margin: 0 1em;
}
    </style>
  </head>
  <body>
    <canvas id="universe" height="400" width="600"></canvas>
    <div id="controls">
      <a href="#" onclick="stop();return false">stop</a>
      <a href="#" onclick="start();return false">start</a>
      <a href="#" onclick="restart();return false">restart</a>
      <a href="#" onclick="toggleCharts(); return false" title="charts only work if you have an Internet connection">charts</a>
    </div>
    <div id="chart"></div>
    <script type="text/javascript">
      var u, makeCharts, loaded;
      function toggleCharts() {
        try {
          makeCharts = !makeCharts;
          if (!loaded) {
            google.load('visualization', '1', {packages: ['corechart']});
            google.setOnLoadCallback(drawChart);
          }
          loaded = true;
        } catch (e) {
          makeCharts = false;
          loaded = false;
        }
      }
      function makeUniverse() {
        u = new Universe("universe", { callback: collectData } );
      }
      makeUniverse();
      var evoData = {
        generation: 0,
        population: {
          names: [ 'Plant', 'Herbivore', 'Carnivore' ],
          rows: []
        }
      };
      function collectData(u) {
        evoData.generation += 1;
        var stats = u.describe();
        var counts = { Plant: 0, Herbivore: 0, Carnivore: 0 };
        for ( var i = 0; i < stats.length; i += 1 ) {
          description = stats[i];
          counts[description['type']] += 1;
        }
        var row = [ evoData.generation, counts.Plant, counts.Herbivore, counts.Carnivore ];
        evoData.population.rows.push(row);
        if (makeCharts)
          drawChart();
      }
      function restart() {
        u.stop();
        evoData.generation = 0;
        evoData.population.rows = [];
        u.erase();
        makeUniverse();
        u.run();
      }
      function stop() {
        u.stop();
      }
      function start() {
        u.start();
      }

      function trimData(data) {
        if (data.length < 500) return data;
        results = [];
        for ( var i = data.length - 500; i < data.length; i += 1 ) {
          results.push(data[i]);
        }
        return results;
      }

      function drawChart() {

        var data = new google.visualization.DataTable();
        data.addColumn( 'number', 'X' );
        for ( var i = 0; i < evoData.population.names.length; i += 1 ) {
          data.addColumn( 'number', evoData.population.names[i] );
        }
        data.addRows(trimData(evoData.population.rows));

        var options = {
          width: 1000,
          height: 500,
          hAxis: {
            title: 'Time (ticks)'
          },
          vAxis: {
            title: 'Population'
          }
        };

        var chart = new google.visualization.LineChart(
          document.getElementById('chart'));

        chart.draw(data, options);

      }
    </script>
  </body>
</html>